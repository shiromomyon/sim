<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é‡åŠ›è»Œé“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v1.7ï¼ˆçŸ¢å°1.5Ã—ï¼å¯¾å‘Î”tå‘ãå‰Šé™¤ï¼Î”tã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼‰</title>
<style>
  :root{ --panel-w: 390px; --bg:#0a0d12; --fg:#e6edf3; --muted:#a8b3c7; --accent:#4aa8ff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif}
  .wrap{display:grid;grid-template-columns:minmax(300px,1fr) var(--panel-w);gap:12px;height:100%;padding:12px}
  .card{background:#0f1420;border:1px solid #1e293b;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .canvas-card{position:relative;display:flex;align-items:center;justify-content:center}
  canvas{width:100%;height:100%;display:block;border-radius:12px}
  .hud{position:absolute;left:10px;top:10px;background:rgba(10,13,18,.55);backdrop-filter:blur(4px);padding:6px 8px;border-radius:10px;font-size:12px;line-height:1.5}
  .title{font-weight:700;font-size:16px;margin:0 0 6px 0;color:#c7d2fe}
  .panel{padding:10px; overflow:auto}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  button{background:#162032;color:#e6edf3;border:1px solid #24324a;border-radius:10px;padding:8px 10px;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1d4ed8,#1e40af);border-color:#1e40af}
  .note{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#101826;border:1px solid #24324a;font-size:11px;color:#a6b1c7;margin-right:6px}
  .legendx{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0}
  .legendx .item{display:flex;align-items:center;gap:6px;font-size:12px;color:#a6b1c7}
  .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
  details{border:1px solid #233047;border-radius:10px;padding:8px;margin:8px 0}
  details>summary{cursor:pointer;font-weight:600;color:#c7d2fe;outline:none}
  .grid{display:grid;grid-template-columns:120px 1fr 80px;gap:6px;align-items:center}
  .grid label{font-size:12px;color:var(--muted)}
  /* å‡ºåŠ›ã®ãƒ©ãƒ™ãƒ«åˆ—ã‚’è©°ã‚ã‚‹ */
  .gridOut{display:grid;grid-template-columns:64px 1fr 64px 1fr;gap:4px;align-items:center}
  .gridOut label{font-size:10.5px;color:#aab3c7}
  .val{min-width:0}
  .compactline{font-size:11.2px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  input[type="range"]{width:100%}
  input[type="number"]{width:100%;padding:5px 6px;border-radius:8px;background:#0a0f18;color:var(--fg);border:1px solid #233047}
  .radio-row-tight{display:flex;gap:4px;flex-wrap:nowrap;white-space:nowrap;overflow:auto;margin-top:6px;font-size:11px}
  .radio-row-tight .pill{font-size:10px;padding:2px 6px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  /* å®šæ•°ã®æ–‡å­— */
  #constOut{font-size:11.2px;line-height:1.35;color:#b9c3d5}
  .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
  .miniBtns button{padding:4px 8px;font-size:11px;border-radius:999px}
</style>
</head>
<body>
  <div class="wrap">
    <!-- å·¦ï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã¿ï¼ˆä¸‹ã«ä½•ã‚‚ç½®ã‹ãªã„ï¼‰ -->
    <div class="card canvas-card" id="canvasCard">
      <canvas id="cv"></canvas>
      <div class="hud" id="hud"></div>
    </div>

    <!-- å³ï¼š1æšã®ãƒ‘ãƒãƒ«ã«ç¸¦1åˆ—ã§ã¾ã¨ã‚ã‚‹ -->
    <div class="card panel">
      <div class="title">åœ°çƒå‘¨å›ãƒ»æ¥•å††è»Œé“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v1.7</div>

      <div class="legendx">
        <div class="item"><span class="swatch" style="background:#4aa8ff"></span>è»Œé“ãƒˆãƒ¬ã‚¤ãƒ«ï¼ˆé€Ÿåº¦è‰²ï¼‰</div>
        <div class="item"><span class="swatch" style="background:#22c55e"></span>ç­‰æ™‚é–“ã®æƒéé ˜åŸŸï¼ˆ<b>ç¾åœ¨â†’æœªæ¥ Î”t</b>ï¼‰</div>
        <div class="item"><span class="swatch" style="background:#38bdf8"></span>å¯¾å‘ä½ç½®t*ã®æœªæ¥ Î”t</div>
        <div class="item"><span class="swatch" style="background:#ffffff;border:1px solid #64748b"></span>é€Ÿåº¦ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆç™½ï¼‰ï¼æœªæ¥Î”tã®å¼§é•·Ã—1.5</div>
      </div>

      <!-- å‹•ä½œï¼šç‹¬ç«‹ï¼ˆãƒœã‚¿ãƒ³ã®ã¿ï¼‰ -->
      <details open>
        <summary>å‹•ä½œ</summary>
        <div class="btns">
          <button id="btnToggle" class="primary">â–¶ å†ç”Ÿ</button>
          <button id="btnReset">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnClearTrail">ğŸ§¹ ãƒˆãƒ¬ã‚¤ãƒ«æ¶ˆå»</button>
        </div>
      </details>

      <!-- æç”»ãƒ»è¦–ç‚¹ãƒ»ç’°å¢ƒï¼šåˆæœŸã¯æŠ˜ã‚ŠãŸãŸã¿ -->
      <details>
        <summary>æç”»ãƒ»è¦–ç‚¹ãƒ»ç’°å¢ƒ</summary>
        <div class="grid">
          <label>é¢ç©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ Î”t[s]</label>
          <input type="range" id="areaDt" min="1" max="1200" step="1" value="600" />
          <input type="number" id="areaDtNum" min="1" max="1200" step="1" value="600" />
          <div style="grid-column: span 3; margin-top:2px" class="miniBtns">
            <button type="button" id="dtBtn400">400</button>
            <button type="button" id="dtBtn600">600</button>
            <button type="button" id="dtBtn800">800</button>
            <button type="button" id="dtBtn1200">1200</button>
          </div>

          <label>è¡¨ç¤º</label>
          <div style="grid-column: span 2;display:flex;align-items:center;gap:8px">
            <label class="pill"><input type="checkbox" id="pair180" /> å¯¾å‘Î”tè¡¨ç¤º</label>
            <label class="pill"><input type="checkbox" id="maskHL" checked/> ãƒã‚¤ãƒ©ã‚¤ãƒˆä¸Šæã</label>
            <label class="pill"><input type="checkbox" id="showPast" checked/> éå»ãƒˆãƒ¬ã‚¤ãƒ«è¡¨ç¤º</label>
          </div>

          <label>ã‚ºãƒ¼ãƒ å€ç‡</label>
          <input type="range" id="zoomMul" min="0.25" max="6.0" step="0.01" value="1.00" />
          <input type="number" id="zoomMulNum" min="0.25" max="6.0" step="0.01" value="1.00" />

          <label>æ™‚é–“å€ç‡ Ã—</label>
          <input type="range" id="timeScale" min="0.1" max="200" step="0.1" value="20" />
          <input type="number" id="timeScaleNum" min="0.1" max="200" step="0.1" value="20" />

          <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
          <div style="grid-column: span 2;display:flex;align-items:center;gap:8px">
            <label class="pill"><input type="checkbox" id="dragOn"/> ç©ºæ°—æŠµæŠ—</label>
          </div>
        </div>
      </details>

      <!-- å‡ºåŠ›ï¼šæ¨ªè©°ã‚ -->
      <details open>
        <summary>å‡ºåŠ›</summary>
        <div class="gridOut">
          <label>r ç¾åœ¨</label><div id="nowROut" class="val compactline">â€”</div>
          <label>r å¯¾å‘</label><div id="oppROut" class="val compactline">â€”</div>

          <label>|v| ç¾åœ¨</label><div id="nowVOut" class="val compactline">â€”</div>
          <label>|v| å¯¾å‘</label><div id="oppVOut" class="val compactline">â€”</div>

          <label>v_circ</label><div id="vcircOut" class="val compactline">â€”</div>
          <label>v_esc</label><div id="vescOut" class="val compactline">â€”</div>

          <label>é¢ç©é€Ÿåº¦</label><div id="hOut" class="val compactline">â€”</div>
          <label>ã‚¨ãƒãƒ«ã‚®ãƒ¼</label><div id="EOut" class="val compactline">â€”</div>

          <label>åˆ¤å®š</label><div id="stateOut" class="val compactline" style="grid-column: span 3">â€”</div>
        </div>
      </details>

      <!-- åˆæœŸæ¡ä»¶ï¼šåˆæœŸã¯æŠ˜ã‚ŠãŸãŸã¿ -->
      <details>
        <summary>åˆæœŸæ¡ä»¶</summary>
        <div class="grid">
          <label>åœ°çƒè³ªé‡ M</label>
          <input type="range" id="mScale" min="0.1" max="5" step="0.1" value="1" />
          <input type="number" id="mScaleNum" min="0.1" max="5" step="0.1" value="1" />

          <label>åœ°çƒåŠå¾„ R</label>
          <input type="range" id="rScale" min="0.5" max="2.0" step="0.01" value="1" />
          <input type="number" id="rScaleNum" min="0.5" max="2.0" step="0.01" value="1" />

          <label>åˆæœŸåŠå¾„ râ‚€/R</label>
          <input type="range" id="r0Scale" min="0" max="10" step="0.01" value="1.00" />
          <input type="number" id="r0ScaleNum" min="0" max="10" step="0.01" value="1.00" />

          <label>åˆæœŸé€Ÿåº¦ vâ‚€/v_circ</label>
          <input type="range" id="v0Mul" min="0.1" max="2.5" step="0.01" value="1.00" />
          <input type="number" id="v0MulNum" min="0.1" max="2.5" step="0.01" value="1.00" />

          <label>åˆæœŸæ–¹ä½è§’ Î¸â‚€[Â°]</label>
          <input type="range" id="theta0" min="0" max="360" step="1" value="90" />
          <input type="number" id="theta0Num" min="0" max="360" step="1" value="90" />
        </div>
        <div class="radio-row-tight">
          <label class="pill"><input type="radio" name="thetaPreset" value="0"> Î¸â‚€=0Â°</label>
          <label class="pill"><input type="radio" name="thetaPreset" value="90" checked> Î¸â‚€=90Â°</label>
          <label class="pill"><input type="radio" name="thetaPreset" value="180"> Î¸â‚€=180Â°</label>
          <label class="pill"><input type="radio" name="thetaPreset" value="270"> Î¸â‚€=270Â°</label>
        </div>
      </details>

      <!-- æ‰“ä¸Šã’æ–¹å‘ï¼šåˆæœŸã¯æŠ˜ã‚ŠãŸãŸã¿ -->
      <details>
        <summary>æ‰“ä¸Šã’æ–¹å‘</summary>
        <div class="grid">
          <label>ä»°è§’ï¼ˆåŠå¾„åŸºæº–ï¼‰</label>
          <input type="range" id="flightAngle" min="-90" max="90" step="1" value="0" />
          <input type="number" id="flightAngleNum" min="-90" max="90" step="1" value="0" />
        </div>
        <div class="note">æ¥ç·šæ–¹å‘ï¼ˆÎ¸â‚€+90Â°ï¼‰ã‚’0Â°åŸºæº–ã€‚ä¸‹ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã“ã®åŸºæº–ã«å¯¾ã™ã‚‹ç›¸å¯¾è§’ã§ã™ã€‚</div>
        <div class="radio-row-tight">
          <label class="pill"><input type="radio" name="faPreset" value="0" checked> 0Â°ï¼ˆæ¥ç·šï¼‰</label>
          <label class="pill"><input type="radio" name="faPreset" value="90"> +90Â°</label>
          <label class="pill"><input type="radio" name="faPreset" value="180"> +180Â°</label>
          <label class="pill"><input type="radio" name="faPreset" value="-90"> -90Â°</label>
        </div>
        <details>
          <summary>çµ¶å¯¾æ–¹ä½ã§æŒ‡å®šï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰</summary>
          <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
            <label class="pill"><input type="checkbox" id="useAbsHeading"> æœ‰åŠ¹åŒ–</label>
          </div>
          <div class="grid">
            <label>çµ¶å¯¾æ–¹ä½[Â°]</label>
            <input type="range" id="headingAbs" min="0" max="360" step="1" value="90" />
            <input type="number" id="headingAbsNum" min="0" max="360" step="1" value="90" />
          </div>
          <div class="radio-row-tight">
            <label class="pill"><input type="radio" name="headPreset" value="0"> 0Â°</label>
            <label class="pill"><input type="radio" name="headPreset" value="90" checked> 90Â°</label>
            <label class="pill"><input type="radio" name="headPreset" value="180"> 180Â°</label>
            <label class="pill"><input type="radio" name="headPreset" value="270"> 270Â°</label>
          </div>
        </details>
      </details>

      <!-- å®šæ•° -->
      <details>
        <summary>å®šæ•°</summary>
        <div id="constOut" class="mono">â€”</div>
      </details>
    </div>
  </div>

<script>
(() => {
  // ====== ç‰©ç†å®šæ•°ï¼ˆSIï¼‰ ======
  const G = 6.67430e-11;     // ä¸‡æœ‰å¼•åŠ›å®šæ•° [m^3 kg^-1 s^-2]
  const M_earth = 5.97219e24; // åœ°çƒè³ªé‡ [kg]
  const R_earth = 6371e3;     // åœ°çƒåŠå¾„ [m]

  // å¤§æ°—ãƒ¢ãƒ‡ãƒ«ï¼ˆç°¡ç•¥ï¼‰
  const rho0 = 1.225;    // æµ·é¢å¯†åº¦ kg/m^3
  const H = 8500;        // ã‚¹ã‚±ãƒ¼ãƒ«ãƒã‚¤ãƒˆ m
  const CdA_over_m = 0.01; // ä¿‚æ•° Cd*A/m ã®æ—¢å®šå€¤

  // ====== DOM ======
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const hud = document.getElementById('hud');
  const card = document.getElementById('canvasCard');

  const mScale = document.getElementById('mScale');
  const rScale = document.getElementById('rScale');
  const r0Scale = document.getElementById('r0Scale');
  const v0Mul = document.getElementById('v0Mul');
  const theta0 = document.getElementById('theta0');
  const flightAngle = document.getElementById('flightAngle');
  const timeScale = document.getElementById('timeScale');
  const zoomMul = document.getElementById('zoomMul');
  const dragOn = document.getElementById('dragOn');
  const areaDt = document.getElementById('areaDt');
  const pair180 = document.getElementById('pair180');
  const maskHL = document.getElementById('maskHL');
  const showPast = document.getElementById('showPast');

  const mScaleNum = document.getElementById('mScaleNum');
  const rScaleNum = document.getElementById('rScaleNum');
  const r0ScaleNum = document.getElementById('r0ScaleNum');
  const v0MulNum = document.getElementById('v0MulNum');
  const theta0Num = document.getElementById('theta0Num');
  const flightAngleNum = document.getElementById('flightAngleNum');
  const timeScaleNum = document.getElementById('timeScaleNum');
  const zoomMulNum = document.getElementById('zoomMulNum');
  const areaDtNum = document.getElementById('areaDtNum');

  const nowROut = document.getElementById('nowROut');
  const nowVOut = document.getElementById('nowVOut');
  const oppROut = document.getElementById('oppROut');
  const oppVOut = document.getElementById('oppVOut');
  const vcircOut = document.getElementById('vcircOut');
  const vescOut  = document.getElementById('vescOut');
  const hOut     = document.getElementById('hOut');
  const EOut     = document.getElementById('EOut');
  const stateOut = document.getElementById('stateOut');
  const constOut = document.getElementById('constOut');

  const btnToggle = document.getElementById('btnToggle');
  const btnReset = document.getElementById('btnReset');
  const btnClearTrail = document.getElementById('btnClearTrail');

  // Î”t ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
  const dtBtn400 = document.getElementById('dtBtn400');
  const dtBtn600 = document.getElementById('dtBtn600');
  const dtBtn800 = document.getElementById('dtBtn800');
  const dtBtn1200 = document.getElementById('dtBtn1200');

  function setDt(val){ areaDt.value = String(val); areaDtNum.value = String(val); }
  dtBtn400.addEventListener('click',()=>{ setDt(400); });
  dtBtn600.addEventListener('click',()=>{ setDt(600); });
  dtBtn800.addEventListener('click',()=>{ setDt(800); });
  dtBtn1200.addEventListener('click',()=>{ setDt(1200); });

  // ãƒ—ãƒªã‚»ãƒƒãƒˆæ–¹ä½
  document.querySelectorAll('input[name="thetaPreset"]').forEach(r=>{
    r.addEventListener('change',()=>{ theta0.value = r.value; theta0Num.value = r.value; applyAndReset(); });
  });
  document.querySelectorAll('input[name="faPreset"]').forEach(r=>{
    r.addEventListener('change',()=>{ flightAngle.value = r.value; flightAngleNum.value = r.value; applyAndReset(); });
  });
  const useAbsHeading = document.getElementById('useAbsHeading');
  const headingAbs = document.getElementById('headingAbs');
  const headingAbsNum = document.getElementById('headingAbsNum');
  document.querySelectorAll('input[name="headPreset"]').forEach(r=>{
    r.addEventListener('change',()=>{ headingAbs.value = r.value; headingAbsNum.value = r.value; });
  });

  // ====== çŠ¶æ…‹ ======
  let state;
  let running = false;
  const dt = 1; // ç‰©ç†åˆ»ã¿ï¼ˆç§’ï¼‰
  let t = 0;
  let trail = [];              // {x,y,v,theta,time}
  let areaTriangles = [];      // ç›´è¿‘Î”tï¼ˆéå»ï¼‰ â€»ä¿æŒã¯ã™ã‚‹
  let areaAll = [];            // éå»å…¨å±¥æ­´ã®ä¸‰è§’å½¢ï¼ˆæ™‚é–“æ¤œç´¢ç”¨ï¼‰

  // åŒæ–¹å‘ãƒã‚¤ãƒ³ãƒ‰
  function bind(sl, num, on){
    const f = () => { num.value = sl.value; on && on(); };
    const g = () => { sl.value = num.value; on && on(); };
    sl.addEventListener('input', f);
    num.addEventListener('input', g);
  }
  bind(mScale, mScaleNum, applyAndReset);
  bind(rScale, rScaleNum, applyAndReset);
  bind(r0Scale, r0ScaleNum, applyAndReset);
  bind(v0Mul, v0MulNum, applyAndReset);
  bind(theta0, theta0Num, applyAndReset);
  bind(flightAngle, flightAngleNum, applyAndReset);
  bind(timeScale, timeScaleNum, ()=>updateOutputs());
  bind(zoomMul, zoomMulNum, ()=>{ draw(); updateOutputs(); });
  bind(areaDt, areaDtNum, ()=>{/*draw only*/});
  bind(headingAbs, headingAbsNum, ()=>{/*draw only*/});

  function resetState() {
    const M = M_earth * parseFloat(mScale.value);
    const R = R_earth * parseFloat(rScale.value);
    const mu = G * M;

    // r0: 1.0ãªã‚‰ã»ã‚“ã®å°‘ã—ã ã‘ä¸Šã’ã¦æ¥è§¦å›é¿ï¼ˆã‚®ãƒªã‚®ãƒªè§¦ã‚Œã¦ã„ãªã„ï¼‰
    let r0 = R * parseFloat(r0Scale.value);
    if (Math.abs(parseFloat(r0Scale.value) - 1.0) < 1e-12) r0 = R * (1 + 1e-6);

    const theta = (+theta0.value) * Math.PI/180; // åˆæœŸæ¥µè§’

    const x0 = r0 * Math.cos(theta);
    const y0 = r0 * Math.sin(theta);

    const vcirc = Math.sqrt(mu / Math.max(r0, 1e-9));
    const v0mag = parseFloat(v0Mul.value) * vcirc;

    let v0;
    if (useAbsHeading && useAbsHeading.checked){
      const ang = (+headingAbs.value) * Math.PI/180; // çµ¶å¯¾æ–¹ä½
      v0 = { x: v0mag*Math.cos(ang), y: v0mag*Math.sin(ang) };
    } else {
      // ä»°è§’ï¼šåŠå¾„ã«å¯¾ã—ã¦ 0=æ¥ç·šæ–¹å‘ï¼ˆ= Î¸â‚€+90Â°ï¼‰ã‚’åŸºæº–
      const fa = (+flightAngle.value) * Math.PI/180;
      const er = {x: Math.cos(theta), y: Math.sin(theta)};     // åŠå¾„æ–¹å‘
      const et = {x: -Math.sin(theta), y: Math.cos(theta)};    // æ¥ç·šæ–¹å‘ï¼ˆCCWï¼‰
      v0 = { x: v0mag * (Math.cos(fa)*et.x + Math.sin(fa)*er.x),
             y: v0mag * (Math.cos(fa)*et.y + Math.sin(fa)*er.y) };
    }

    state = { M, R, mu, r: {x:x0,y:y0}, v: v0, alive: true };

    t = 0;
    trail = [];
    areaTriangles = [];
    areaAll = [];
    pushTrail(state.r, Math.hypot(v0.x,v0.y), t);
    updateOutputs();
    updateConstPanel();
  }

  function pushTrail(r, vmag, time){
    const theta = Math.atan2(r.y, r.x); // [-Ï€,Ï€]
    trail.push({x:r.x, y:r.y, v: vmag, theta, time: (time!==undefined? time : t)});
    const maxPts = 60000; if (trail.length > maxPts) trail.shift();
  }

  function energyPerMass(r,v){
    const rmag = Math.hypot(r.x, r.y);
    const v2 = v.x*v.x + v.y*v.y;
    return 0.5*v2 - state.mu/rmag;
  }
  function hScalar(r,v){ return r.x*v.y - r.y*v.x; }
  function atmosphericDensity(rmag){
    const alt = rmag - state.R; if (alt <= 0) return rho0; return rho0 * Math.exp(-alt / H);
  }

  function accel(r, v){
    const rmag = Math.hypot(r.x, r.y);
    const invr3 = 1 / (rmag*rmag*rmag + 1e-30);
    let ax = -state.mu * r.x * invr3;
    let ay = -state.mu * r.y * invr3;
    if (dragOn.checked){
      const rho = atmosphericDensity(rmag);
      const vmag = Math.hypot(v.x, v.y) || 1e-9;
      const q = 0.5 * rho * vmag*vmag * CdA_over_m;
      ax += -q * (v.x / vmag);
      ay += -q * (v.y / vmag);
    }
    return {ax, ay};
  }

  function rk4AdvanceLocal(r, v, h){
    const a0 = accel(r, v);
    const k1r = {x: v.x,           y: v.y};
    const k1v = {x: a0.ax,         y: a0.ay};

    const r1 = {x: r.x + 0.5*h*k1r.x, y: r.y + 0.5*h*k1r.y};
    const v1 = {x: v.x + 0.5*h*k1v.x, y: v.y + 0.5*h*k1v.y};

    const a1 = accel(r1, v1);
    const k2r = {x: v1.x,          y: v1.y};
    const k2v = {x: a1.ax,         y: a1.ay};

    const r2 = {x: r.x + 0.5*h*k2r.x, y: r.y + 0.5*h*k2r.y};
    const v2 = {x: v.x + 0.5*h*k2v.x, y: v.y + 0.5*h*k2v.y};
    const a2 = accel(r2, v2);
    const k3r = {x: v2.x,          y: v2.y};
    const k3v = {x: a2.ax,         y: a2.ay};

    const r3 = {x: r.x + h*k3r.x,  y: r.y + h*k3r.y};
    const v3 = {x: v.x + h*k3v.x,  y: v.y + h*k3v.y};
    const a3 = accel(r3, v3);
    const k4r = {x: v3.x,          y: v3.y};
    const k4v = {x: a3.ax,         y: a3.ay};

    const rn = { x: r.x + (h/6)*(k1r.x + 2*k2r.x + 2*k3r.x + k4r.x),
                 y: r.y + (h/6)*(k1r.y + 2*k2r.y + 2*k3r.y + k4r.y) };
    const vn = { x: v.x + (h/6)*(k1v.x + 2*k2v.x + 2*k3v.x + k4v.x),
                 y: v.y + (h/6)*(k1v.y + 2*k2v.y + 2*k3v.y + k4v.y) };
    return { r: rn, v: vn };
  }

  function rk4Step(){
    const h = dt * parseFloat(timeScale.value);
    const res = rk4AdvanceLocal(state.r, state.v, h);
    state.r = res.r; state.v = res.v; t += h;
  }

  function update(){
    if (running && state.alive){
      const prevR = {x: state.r.x, y: state.r.y};
      rk4Step();
      const vmag = Math.hypot(state.v.x, state.v.y);
      pushTrail(state.r, vmag, t);

      // ä¸‰è§’å½¢å±¥æ­´: ç›´è¿‘Î”tï¼ˆéå»ï¼‰ & å…¨å±¥æ­´
      const tri = [ {x:0,y:0}, {x:prevR.x,y:prevR.y}, {x:state.r.x,y:state.r.y} ];
      const th = Math.atan2(state.r.y, state.r.x);
      const rec = {tri, time:t, theta:th};
      areaTriangles.push(rec);
      areaAll.push(rec);
      const windowS = parseFloat(areaDt.value);
      while(areaTriangles.length && (t - areaTriangles[0].time) > windowS){ areaTriangles.shift(); }
      const maxAll = 200000; if (areaAll.length > maxAll) areaAll.shift();

      // è¡çª â‡’ æ­¢ã‚ã‚‹ï¼ˆæç”»ã¯ä¿æŒï¼‰
      const rmag = Math.hypot(state.r.x, state.r.y);
      if (rmag <= state.R){ state.alive = false; running = false; btnToggle.textContent = 'â–¶ å†ç”Ÿ'; }
    }

    draw();
    updateOutputs();
    requestAnimationFrame(update);
  }

  // ====== åŠå‘¨æœŸã®è¿‘ä¼¼ï¼ˆæ¥•å††ãƒ»ç„¡æŠµæŠ—ï¼‰ ======
  function halfPeriod(){
    if (dragOn.checked) return null;
    const eps = energyPerMass(state.r, state.v);
    if (eps >= 0) return null; // æ”¾ç‰©/åŒæ›²ã¯å¯¾è±¡å¤–
    const a = -state.mu/(2*eps);
    const T = 2*Math.PI*Math.sqrt(a*a*a/state.mu);
    return T*0.5;
  }

  // ====== å¯¾å‘æ™‚åˆ» t* ã‚’å±¥æ­´ã®è§’åº¦äº¤å·®ã§å³å¯†åŒ– ======
  function oppositeTimePrecise(){
    if (areaAll.length < 2) return null;
    const thetaNow = Math.atan2(state.r.y, state.r.x);
    const target = wrapPi(thetaNow - Math.PI);
    let best=null; let bestErr=1e99;
    const tau = halfPeriod();
    function d(a){ return wrapPi(a - target); }
    for (let i=1;i<areaAll.length;i++){
      const A = areaAll[i-1], B = areaAll[i];
      if (B.time >= t - 1e-6) break; // éå»å´ã®ã¿
      const dA = d(A.theta), dB = d(B.theta);
      if (dA===0){ best = A.time; break; }
      // äº¤å·®åˆ¤å®šï¼ˆç¬¦å·ãŒç•°ãªã‚‹ï¼‰
      if (dA * dB <= 0){
        const s = Math.abs(dA) / (Math.abs(dA) + Math.abs(dB) + 1e-12);
        const tCross = A.time + s*(B.time - A.time);
        if (tau){
          const err = Math.abs((t - tau) - tCross);
          if (err < bestErr){ best=tCross; bestErr=err; }
        } else {
          // tauãªã—ãªã‚‰ç›´è¿‘ã®äº¤å·®ã‚’æ¡ç”¨
          best = tCross;
        }
      }
    }
    return best;
  }

  function wrapPi(a){ while(a<=-Math.PI) a+=2*Math.PI; while(a>Math.PI) a-=2*Math.PI; return a; }

  // ====== æœªæ¥Î”tï¼ˆä¸‰è§’å½¢åˆ— & å¼§é•·ï¼‰ã‚’ç¾åœ¨ã‹ã‚‰äºˆæ¸¬ç”Ÿæˆ ======
  function futurePreview(windowS){
    const h = dt * parseFloat(timeScale.value);
    const steps = Math.max(1, Math.ceil(windowS / h));
    let r = {x: state.r.x, y: state.r.y};
    let v = {x: state.v.x, y: state.v.y};
    const tris = [];
    let arcLen = 0; // æœªæ¥Î”tã®å¼§é•·ï¼ˆmï¼‰
    for (let i=0;i<steps;i++){
      const prevR = {x:r.x, y:r.y};
      const adv = rk4AdvanceLocal(r, v, h);
      r = adv.r; v = adv.v;
      const tri = [ {x:0,y:0}, {x:prevR.x,y:prevR.y}, {x:r.x,y:r.y} ];
      tris.push(tri);
      arcLen += Math.hypot(r.x - prevR.x, r.y - prevR.y);
      const rmag = Math.hypot(r.x, r.y); if (rmag <= state.R) break; // è¡çªäºˆè¦‹ã§æ‰“åˆ‡ã‚Š
    }
    return { tris, arcLen };
  }

  function drawHighlights(scale, futTris){
    // ç·‘ï¼šç¾æ™‚åˆ»ã® æœªæ¥Î”t ã‚’äºˆæ¸¬æç”»
    if (futTris && futTris.length){
      ctx.fillStyle = 'rgba(34,197,94,0.35)'; ctx.strokeStyle = 'rgba(34,197,94,0.75)'; ctx.lineWidth = 1;
      for (const tri of futTris){ ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(tri[1].x*scale, -tri[1].y*scale); ctx.lineTo(tri[2].x*scale, -tri[2].y*scale); ctx.closePath(); ctx.fill(); ctx.stroke(); }
    }

    // æ°´è‰²ï¼šå¯¾å‘æ™‚åˆ» t* ã® æœªæ¥ [t*, t*+Î”t]
    if (pair180.checked && areaAll.length){
      const tOpp = oppositeTimePrecise();
      if (tOpp !== null){
        const windowS = parseFloat(areaDt.value);
        const tStart = tOpp - 1e-6, tEnd = tOpp + windowS + 1e-6;
        ctx.fillStyle = 'rgba(56,189,248,0.35)'; ctx.strokeStyle='rgba(56,189,248,0.75)'; ctx.lineWidth = 1;
        for (let i = areaAll.length-1; i >= 0; i--){
          const rec = areaAll[i];
          if (rec.time > tEnd) continue;
          if (rec.time < tStart) break;
          const tri = rec.tri; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(tri[1].x*scale, -tri[1].y*scale); ctx.lineTo(tri[2].x*scale, -tri[2].y*scale); ctx.closePath(); ctx.fill(); ctx.stroke();
        }
      }
    }
  }

  function drawTrail(scale){
    if (!showPast.checked) return; // éå»ãƒˆãƒ¬ã‚¤ãƒ«éè¡¨ç¤º
    for (let i=1;i<trail.length;i++){
      const p0 = trail[i-1], p1 = trail[i];
      const rmag = Math.hypot(p1.x, p1.y);
      const vc = Math.sqrt(state.mu / Math.max(rmag,1e-6));
      const ve = Math.sqrt(2*state.mu / Math.max(rmag,1e-6));
      ctx.strokeStyle = speedColor(p1.v, vc, ve);
      ctx.lineWidth = 1.6; ctx.beginPath(); ctx.moveTo(p0.x*scale, -p0.y*scale); ctx.lineTo(p1.x*scale, -p1.y*scale); ctx.stroke();
    }
  }

  function speedColor(v, vc, ve){
    const v0 = 0.5*vc; const v1 = ve; const u = Math.max(0, Math.min(1, (v - v0)/(v1 - v0 + 1e-9)));
    const mid = 0.65; let r,g,b;
    if (u < mid){ const t=u/mid; r=68+t*(255-68); g=170+t*(200-170); b=255+t*(40-255); }
    else { const t=(u-mid)/(1-mid); r=255; g=200+t*(80-200); b=40+t*(80-40); }
    return `rgb(${r|0},${g|0},${b|0})`;
  }

  function computeScale(){
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ 2.0 ã‚’ 1x ã¨ã—ã¦æ‰±ã†
    const pad = 1.1;
    let maxr = state.R * 1.2;
    for (const p of trail){ const rr = Math.hypot(p.x, p.y); if (rr > maxr) maxr = rr; }
    const base = (Math.min(cv.width, cv.height) * 0.46) / (maxr * pad);
    return base * (parseFloat(zoomMul.value)/2.0);
  }

  function draw(){
    const dpr = window.devicePixelRatio || 1;
    const rect = card.getBoundingClientRect();
    const w = Math.floor(rect.width), h = Math.floor(rect.height);
    if (cv.width !== Math.floor(w*dpr) || cv.height !== Math.floor(h*dpr)){ cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); }
    ctx.clearRect(0,0,w,h);

    const cx = w*0.5, cy = h*0.5; const scale = computeScale();

    // æœªæ¥Î”tãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å…ˆã«è¨ˆç®—ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼†çŸ¢å°ã§å…±ç”¨ï¼‰
    const windowS = parseFloat(areaDt.value);
    const fut = futurePreview(windowS);

    // èƒŒæ™¯
    ctx.save(); ctx.globalAlpha = 0.25; for (let i=0;i<80;i++){ const x=(i*97%w), y=(i*57%h); ctx.fillStyle = i%9?'#111827':'#0b1220'; ctx.fillRect(x,y,2,2);} ctx.restore();

    ctx.save(); ctx.translate(cx, cy);

    // åœ°çƒ
    ctx.fillStyle = '#102c44'; ctx.strokeStyle = '#23405c'; ctx.lineWidth = 1.2;
    const Re_pix = state.R * scale; ctx.beginPath(); ctx.arc(0,0, Math.max(2, Re_pix), 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // æç”»é †ï¼šãƒã‚¤ãƒ©ã‚¤ãƒˆä¸ŠæããŒONãªã‚‰ã€å…ˆã«è»Œé“â†’å¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‘ã€OFFãªã‚‰å¾“æ¥é †
    if (maskHL.checked){
      drawTrail(scale);
      drawHighlights(scale, fut.tris);
    } else {
      drawHighlights(scale, fut.tris);
      drawTrail(scale);
    }

    // è¡›æ˜Ÿã¨ã€ç™½é€Ÿåº¦çŸ¢å°ã€‘ï¼ˆç¾åœ¨ä½ç½®ã‚’èµ·ç‚¹ã€æ–¹å‘=vã€é•·ã•=æœªæ¥Î”tã®å¼§é•·Ã—1.5ï¼‰
    const sat = {x: state.r.x*scale, y: -state.r.y*scale};
    const rmagNow = Math.hypot(state.r.x, state.r.y);
    const vcNow = Math.sqrt(state.mu/Math.max(rmagNow,1e-6));
    const veNow = Math.sqrt(2*state.mu / Math.max(rmagNow,1e-6));
    const vmagNow = Math.hypot(state.v.x, state.v.y);
    ctx.fillStyle = speedColor(vmagNow, vcNow, veNow);
    ctx.beginPath(); ctx.arc(sat.x, sat.y, 3.6, 0, Math.PI*2); ctx.fill();

    // çŸ¢å°
    if (vmagNow > 1e-9){
      const vx = state.v.x, vy = state.v.y;
      const ux = vx / vmagNow, uy = vy / vmagNow; // å˜ä½é€Ÿåº¦ãƒ™ã‚¯ãƒˆãƒ«
      let lenPx = fut.arcLen * scale * 1.5; // â˜… 1.5å€
      if (!isFinite(lenPx) || lenPx <= 0){
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ—§ã‚²ã‚¤ãƒ³ï¼‰
        lenPx = vmagNow * 0.02 * 0.8 * scale * 1.5; // â˜… 1.5å€
      }
      // ä¸Šé™ã‚’ç”»é¢ã®40%ã«åˆ¶é™
      const maxLen = Math.min(w, h) * 0.4; if (lenPx > maxLen) lenPx = maxLen;
      const ax =  ux * lenPx;
      const ay = -uy * lenPx; // yåè»¢
      ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 1.8;
      ctx.beginPath(); ctx.moveTo(sat.x, sat.y); ctx.lineTo(sat.x + ax, sat.y + ay); ctx.stroke();
      const ang = Math.atan2(ay, ax); const ah = Math.max(8, Math.min(16, lenPx*0.12));
      const a1 = ang + Math.PI*0.82; const a2 = ang - Math.PI*0.82;
      const tx = sat.x + ax, ty = sat.y + ay; ctx.beginPath(); ctx.moveTo(tx,ty); ctx.lineTo(tx + ah*Math.cos(a1), ty + ah*Math.sin(a1)); ctx.lineTo(tx + ah*Math.cos(a2), ty + ah*Math.sin(a2)); ctx.closePath(); ctx.fillStyle='#ffffff'; ctx.fill();
    }

    ctx.restore();

    hud.innerHTML = `t = ${t.toFixed(1)} s` + (running? ' <span class="pill">RUN</span>':' <span class="pill">PAUSE</span>');
  }

  // è¿‘ä¼¼ã®å¯¾å‘ç‚¹ï¼ˆç†è«–ï¼‰
  function oppositeAnomalyRV(){
    const eps = energyPerMass(state.r, state.v);
    if (dragOn.checked || eps >= 0) return null; // è¿‘ä¼¼ã—ãªã„
    const r = state.r, v = state.v, mu = state.mu;
    const rmag = Math.hypot(r.x,r.y);
    const h = hScalar(r,v); const hz = h;
    const vx=v.x, vy=v.y; const rx=r.x, ry=r.y; const rhat = {x: rx/rmag, y: ry/rmag};
    const vxh = {x: vy*hz, y: -vx*hz};
    const evec = {x: vxh.x/mu - rhat.x, y: vxh.y/mu - rhat.y};
    const e = Math.hypot(evec.x, evec.y); if (!(e<1)) return null;
    const a = -mu/(2*eps);
    const pHatNorm = Math.hypot(evec.x,evec.y) || 1; const pHat = {x: evec.x/pHatNorm, y: evec.y/pHatNorm};
    const qHat = {x: -pHat.y, y: pHat.x};
    const cosnu = (r.x*pHat.x + r.y*pHat.y)/rmag; let nu = Math.acos(Math.max(-1, Math.min(1, cosnu)));
    const sinu = (r.x*qHat.x + r.y*qHat.y)/rmag; if (sinu<0) nu = -nu;
    const nu2 = nu + Math.PI; const r2 = a*(1-e*e) / (1 + e*Math.cos(nu2));
    const v2 = Math.sqrt(mu*(2/r2 - 1/a));
    return { r2, v2 };
  }

  function updateOutputs(){
    const rmag = Math.hypot(state.r.x, state.r.y);
    const vmag = Math.hypot(state.v.x, state.v.y);
    const vcirc = Math.sqrt(state.mu / Math.max(rmag,1e-9));
    const vesc  = Math.sqrt(2*state.mu / Math.max(rmag,1e-9));

    nowROut.textContent = `${(rmag/1000).toFixed(2)} km`;
    nowVOut.textContent = `${(vmag/1000).toFixed(3)} km/s`;

    const opp = oppositeAnomalyRV();
    if (opp){
      oppROut.textContent = `${(opp.r2/1000).toFixed(2)} km`;
      oppVOut.textContent = `${(opp.v2/1000).toFixed(3)} km/s`;
    } else {
      oppROut.textContent = 'â€”';
      oppVOut.textContent = 'â€”';
    }

    vcircOut.textContent = `${(vcirc/1000).toFixed(3)} km/s`;
    vescOut.textContent  = `${(vesc/1000).toFixed(3)} km/s`;

    const h = Math.abs(hScalar(state.r, state.v));
    const areal = h/2; // é¢ç©é€Ÿåº¦
    hOut.innerHTML = `${sciStr(areal,4)} mÂ²/s`;

    const e = energyPerMass(state.r, state.v);
    EOut.innerHTML = `${sciStr(e,4)} J/kg`;

    let s = 'â€”';
    if (rmag <= state.R){ s = 'å¢œè½'; }
    else if (e >= 0){ s = (Math.abs(e) < 1e-2) ? 'æ”¾ç‰©ç·šï¼ˆè‡¨ç•Œï¼‰' : 'è„±å‡ºï¼ˆåŒæ›²ç·šï¼‰'; }
    else { s = 'å‘¨å›ï¼ˆæ¥•å††ï¼‰'; }
    stateOut.textContent = s;
  }

  // æŒ‡æ•°è¡¨è¨˜ã‚’ Ã—10^n ã«æ•´å½¢ï¼ˆè² å·ã‚‚ãã®ã¾ã¾ï¼‰
  function sciStr(num, sig=3){
    if (!isFinite(num)) return 'â€”';
    const s = num.toExponential(sig-1);
    const [m,e] = s.split('e');
    const exp = parseInt(e,10);
    return `${m}Ã—10<sup>${exp}</sup>`;
  }

  function updateConstPanel(){
    const M = M_earth * parseFloat(mScale.value);
    const R = R_earth * parseFloat(rScale.value);
    const mu = G * M;
    constOut.innerHTML = `
      <div>G = ${sciStr(G,4)} [mÂ³Â·kgâ»Â¹Â·sâ»Â²]</div>
      <div>Mâ‚‘ = ${sciStr(M_earth,4)} kg, Râ‚‘ = ${(R_earth/1000).toFixed(0)} km</div>
      <div>ç¾åœ¨: M = ${sciStr(M,4)} kg (Ã—${parseFloat(mScale.value).toFixed(2)})</div>
      <div>R = ${(R/1000).toFixed(0)} km (Ã—${parseFloat(rScale.value).toFixed(2)})</div>
      <div>é‡åŠ›å®šæ•° Î¼ = GM = ${sciStr(mu,4)} mÂ³/sÂ²</div>
    `;
  }

  function applyAndReset(){ resetState(); draw(); }

  dragOn.addEventListener('change', ()=>{ areaTriangles = []; areaAll = []; });
  areaDt.addEventListener('input', ()=>{/*draw only*/});
  pair180.addEventListener('change', ()=>{/*draw only*/});

  btnToggle.addEventListener('click', ()=>{
    running = !running;
    btnToggle.textContent = running ? 'â¸ ä¸€æ™‚åœæ­¢' : 'â–¶ å†ç”Ÿ';
    if (running) btnToggle.classList.add('primary'); else btnToggle.classList.add('primary');
  });
  btnReset.addEventListener('click', ()=>{ resetState(); });
  btnClearTrail.addEventListener('click', ()=>{ trail = []; areaTriangles = []; areaAll = []; pushTrail(state.r, Math.hypot(state.v.x,state.v.y), t); });

  // åˆæœŸåŒ–
  resetState();
  requestAnimationFrame(update);
})();
</script>
</body>
</html>
